#!/usr/bin/bash
ROOT="$HOME/.config/panel"
source $ROOT/config

# create the socket (and remove if necessary)
[ -e "$fifo" ] && rm "$fifo"
mkfifo "$fifo"

# create the pid file (and kill existing panels if necessary)
[ -e "$pidfile" ] && pkill -P $(cat "$pidfile")
echo $$ >"$pidfile"

# initiate modules
declare -A modules
for module in $ROOT/modules/* ; do
    $module "$@" >"$fifo" &
done

# main loop
while IFS='' read -r cmd; do
    IFS="$cmd_ifs" read -ra infos <<< "$cmd"
    modules[${infos[0]}]="${infos[1]}"

    echo "%{l} ${modules[title]}%{c}${modules[tags]}%{r}${modules[song]} ${modules[clock]}  %{F-}"

done <"$fifo" | /usr/bin/lemonbar -pg ${width}x${height}+${x}+${y} \
    -f 'Inconsolata\-g:style=Regular:size=8' \
    -f 'Material\-Design\-Iconic\-Font:style=Design-Icon-Font:size=11' \
    -f 'Terminus:size=9' -B $back_color -F $fore_color | $sh

wait
